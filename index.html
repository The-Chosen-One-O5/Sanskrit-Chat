<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanskrit Universal Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons and Firebase are now initialized in the main module script below -->
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --color-primary: #FACC15; /* Yellow */
            --color-orange: #F97316; /* Orange */
            --color-blue: #3B82F6; /* Blue */
            --color-red: #EF4444; /* Red */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better mobile view */
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .card {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 500px;
        }
        .chat-message-container {
            /* Scrollable area */
            max-height: 70vh;
            overflow-y: auto;
        }
        /* Custom scrollbar for aesthetics */
        .chat-message-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-message-container::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 4px;
        }
    </style>
</head>
<body class="app-container">

    <div id="app" class="card rounded-xl p-6 transition-all duration-300">
        <!-- Application State Renders Here -->
        <h1 class="text-3xl font-extrabold text-black mb-6 text-center">
            <span class="text-yellow-600">Sanskrit</span> Chat
        </h1>

        <!-- Loading Indicator -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto"></div>
                <p class="mt-4 text-gray-700 font-semibold">Loading...</p>
            </div>
        </div>
        
        <!-- Error Message Box -->
        <div id="error-message" class="hidden mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert">
            <div class="flex items-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2 text-red-500"></i>
                <span id="error-text" class="font-medium"></span>
            </div>
        </div>

        <!-- Render based on appState (NAME_INPUT, ROOM_SELECTION, JOIN_INPUT, CHAT) -->
        <div id="lobby-view"></div>
        <div id="join-input-view" class="hidden"></div>
        <div id="chat-view" class="hidden"></div>

    </div>

    <!-- Firebase SDKs and Main Application Logic -->
    <script type="module">
        // --- LUCIDE ICONS (Now using esm.sh for better compatibility) ---
        import { createIcons, Search, MessageSquare, Plus, LogIn, Send, Copy, AlertTriangle, Check } from 'https://esm.sh/lucide@latest';

        // --- FIREBASE SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp, setLogLevel, query, orderBy, limit, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Define the set of icons to be rendered, as required by createIcons
        const lucideIcons = { Search, MessageSquare, Plus, LogIn, Send, Copy, AlertTriangle, Check };

        // Constants and State
        const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
        const GROQ_API_KEY = "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"; 
        const GROQ_MODEL_ID = "openai/gpt-oss-120b";
        
        // Define the explicit Firebase config provided by the user for a robust fallback
        const USER_PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDK_RPUQaQ86dzRhOOrrzRvRcG5pMyHR_E",
            authDomain: "sanskrit-chat.firebaseapp.com",
            projectId: "sanskrit-chat",
            storageBucket: "sanskrit-chat.firebasestorage.app",
            messagingSenderId: "328437332405",
            appId: "1:328437332405:web:ffd31f848b2351501fc1fc",
            measurementId: "G-X14R907GQB"
        };

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sanskrit-chat-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // FIX: Ensure firebaseConfig is always defined with the project ID by using a fallback.
        let firebaseConfig = USER_PROVIDED_FIREBASE_CONFIG;
        if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '') {
            try {
                // Prioritize the environment config if available and valid
                const envConfig = JSON.parse(__firebase_config);
                if (envConfig.projectId) {
                    firebaseConfig = envConfig;
                }
            } catch (e) {
                console.warn("Could not parse __firebase_config, using hardcoded fallback.");
            }
        }
        
        let db;
        let auth;
        let userId = null;
        let userName = ''; // New state for user's chosen name
        let appState = 'NAME_INPUT'; // Updated initial state
        let currentRoomCode = '';
        let messages = [];
        let isAuthReady = false;

        // DOM elements
        const lobbyView = document.getElementById('lobby-view');
        const joinInputView = document.getElementById('join-input-view');
        const chatView = document.getElementById('chat-view');
        const appContainer = document.getElementById('app');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const loadingOverlay = document.getElementById('loading-overlay');

        // Utility Functions
        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        function renderState() {
            lobbyView.innerHTML = '';
            joinInputView.innerHTML = '';
            chatView.innerHTML = '';

            lobbyView.classList.add('hidden');
            joinInputView.classList.add('hidden');
            chatView.classList.add('hidden');

            switch (appState) {
                case 'NAME_INPUT': // New state: Capture user name
                    renderNameInput();
                    lobbyView.classList.remove('hidden');
                    break;
                case 'ROOM_SELECTION': // New state: Show create/join buttons
                    renderRoomSelection();
                    lobbyView.classList.remove('hidden'); // Reusing lobby view for simplicity
                    break;
                case 'JOIN_INPUT':
                    renderJoinInput();
                    joinInputView.classList.remove('hidden');
                    break;
                case 'CHAT':
                    renderChat();
                    chatView.classList.remove('hidden');
                    break;
            }
            // Re-run icon initialization with the imported icons object
            createIcons({ icons: lucideIcons });
        }

        // --- AUTH & FIREBASE SETUP ---

        async function initializeFirebase() {
            try {
                // setLogLevel('debug'); // Uncomment for verbose firebase logging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            userId = crypto.randomUUID(); // Fallback for unauthenticated but running (will use custom token later)
                        }

                        // Try custom sign-in first, then anonymous
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                                userId = auth.currentUser.uid;
                            } catch (e) {
                                console.error("Custom token sign-in failed, falling back to anonymous:", e);
                                await signInAnonymously(auth);
                                userId = auth.currentUser.uid;
                            }
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser.uid;
                        }
                        
                        isAuthReady = true;
                        resolve();
                    });
                });
                renderState(); // Initial render after auth is ready

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showError("Failed to connect to the database. Please check your configuration.");
                // Ensure icons are created even on error to render the alert-triangle icon
                createIcons({ icons: lucideIcons });
            }
        }

        // --- SYSTEM MESSAGE SENDER ---
        async function sendSystemMessage(roomCode, type) {
            // type will be 'JOINED' or 'LEFT'
            try {
                if (!db || !userName) throw new Error("Database or user name not ready.");
                const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode, 'messages');

                await addDoc(messagesRef, {
                    type: 'system',
                    text: `${userName} has ${type.toLowerCase()} the chat.`,
                    userName: userName,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Failed to send system message:", e);
            }
        }


        // --- ROOM MANAGEMENT ---

        function generateRoomCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }

        async function createRoom() {
            showLoading();
            const newCode = generateRoomCode();
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, newCode);
            try {
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.exists()) {
                    hideLoading();
                    return createRoom(); 
                }

                await setDoc(roomRef, { 
                    createdAt: serverTimestamp(), 
                    hostId: userId,
                    hostName: userName // Store host name
                });
                
                currentRoomCode = newCode;
                appState = 'CHAT';
                renderState();
                listenToChat(newCode);
                sendSystemMessage(newCode, 'JOINED'); // Send join message

            } catch (e) {
                console.error("Error creating room:", e);
                showError("Failed to create room. Please try again.");
            } finally {
                hideLoading();
            }
        }

        async function joinRoom(code) {
            code = code.toUpperCase().trim();
            if (!code || code.length !== 6) {
                showError("Invalid room code. It must be 6 characters.");
                return;
            }

            showLoading();
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, code);

            try {
                const roomSnap = await getDoc(roomRef);
                if (!roomSnap.exists()) {
                    showError(`Room '${code}' not found. Check the code.`);
                    return;
                }
                
                currentRoomCode = code;
                appState = 'CHAT';
                renderState();
                listenToChat(code);
                sendSystemMessage(code, 'JOINED'); // Send join message

            } catch (e) {
                console.error("Error joining room:", e);
                showError("Failed to join room. Database error.");
            } finally {
                hideLoading();
            }
        }

        function listenToChat(roomCode) {
            if (!db || !userId) {
                showError("Database or User not ready.");
                return;
            }

            const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode, 'messages');
            const messagesQuery = query(messagesRef, orderBy('timestamp', 'asc'));

            // Set up real-time listener
            onSnapshot(messagesQuery, (snapshot) => {
                const newMessages = [];
                snapshot.forEach(doc => {
                    newMessages.push({ id: doc.id, ...doc.data() });
                });
                messages = newMessages;
                renderChatMessages();
            }, (error) => {
                console.error("Error listening to messages:", error);
                showError("Real-time connection lost. Check your network.");
            });
        }

        // --- GROQ TRANSLATION API ---

        async function callGroqApi(prompt) {
            const maxRetries = 3;
            let lastError = null;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const payload = {
                        model: GROQ_MODEL_ID,
                        messages: [
                            {
                                role: "system",
                                content: "You are an expert Sanskrit language translator. Translate the user's input (which may be English or Hinglish) into pure, correct Sanskrit using the Devanagari script. Do not include any explanation, commentary, or extra text, only the translated Sanskrit phrase."
                            },
                            {
                                role: "user",
                                content: prompt
                            }
                        ],
                        temperature: 0.1,
                        max_tokens: 100
                    };

                    const response = await fetch(GROQ_API_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${GROQ_API_KEY}` 
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const translatedText = result.choices?.[0]?.message?.content?.trim();
                    
                    if (!translatedText) {
                        throw new Error("API response was empty or malformed.");
                    }
                    return translatedText;

                } catch (e) {
                    lastError = e;
                    console.warn(`Attempt ${attempt + 1} failed:`, e);
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }

            throw new Error(`Translation failed after ${maxRetries} attempts. ${lastError.message}`);
        }

        async function translateAndSendMessage(originalText) {
            if (!originalText.trim()) return;

            showLoading();
            let sanskritText = "Translation failed.";
            let success = false;

            try {
                // 1. Translate the message
                sanskritText = await callGroqApi(originalText);
                success = true;
                
            } catch (e) {
                console.error("Translation error:", e);
                showError("Sanskrit translation failed. Check API connection.");
                // Use a fallback text if translation fails
                sanskritText = `[Translation Error] ${originalText}`; 
            }

            // 2. Send the message to Firestore
            try {
                if (!db || !currentRoomCode) throw new Error("Chat not initialized.");

                const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, currentRoomCode, 'messages');

                await addDoc(messagesRef, {
                    originalText: originalText,
                    sanskritText: sanskritText,
                    userId: userId,
                    userName: userName, // Including user name
                    type: 'user', // Defining message type
                    timestamp: serverTimestamp()
                });

                document.getElementById('message-input').value = ''; // Clear input
                
            } catch (e) {
                console.error("Failed to send message:", e);
                showError("Could not send message to the room.");
            } finally {
                hideLoading();
            }
        }


        // --- RENDERING FUNCTIONS ---
        
        function renderNameInput() {
            lobbyView.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Welcome to Sanskrit Chat!</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">First, enter your name to begin.</p>
                <input id="user-name-input" type="text" placeholder="Your Name" maxlength="20" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg mb-4">
                <button id="set-name-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    Continue
                </button>
            `;
            document.getElementById('set-name-btn').addEventListener('click', () => {
                const name = document.getElementById('user-name-input').value.trim();
                if (name) {
                    userName = name.substring(0, 20); // Truncate name to 20 chars
                    appState = 'ROOM_SELECTION';
                    renderState();
                } else {
                    showError("Please enter a name.");
                }
            });
        }

        function renderRoomSelection() {
            lobbyView.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Hello, ${userName}!</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">Select an option to begin your communication journey to Sanskrit.</p>
                <div class="space-y-4">
                    <button id="create-room-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Create a Room
                    </button>
                    <button id="join-input-btn" class="w-full flex items-center justify-center bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                        <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                        Join a Room
                    </button>
                </div>
            `;
            document.getElementById('create-room-btn').addEventListener('click', createRoom);
            document.getElementById('join-input-btn').addEventListener('click', () => {
                appState = 'JOIN_INPUT';
                renderState();
            });
        }

        function renderJoinInput() {
            joinInputView.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Enter Room Code</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">Enter the 6-character code shared by the host.</p>
                <input id="room-code-input" type="text" placeholder="e.g., ABC123" maxlength="6" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg uppercase mb-4 text-center tracking-widest font-mono">
                <button id="join-room-action-btn" class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    <i data-lucide="search" class="w-5 h-5 mr-2"></i>
                    Connect to Chat
                </button>
                <button id="back-to-room-selection-btn" class="w-full mt-3 text-sm text-gray-500 hover:text-gray-700 p-2">
                    Back to Options
                </button>
            `;
            document.getElementById('join-room-action-btn').addEventListener('click', () => {
                const code = document.getElementById('room-code-input').value;
                joinRoom(code);
            });
            document.getElementById('back-to-room-selection-btn').addEventListener('click', () => {
                appState = 'ROOM_SELECTION';
                renderState();
            });
        }

        function renderChat() {
            chatView.innerHTML = `
                <div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-yellow-500">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="message-square" class="w-6 h-6 mr-2 text-orange-500"></i>
                        Room: ${currentRoomCode}
                    </h2>
                    <button id="leave-room-btn" class="text-sm text-red-500 hover:text-red-700 font-semibold p-1 transition duration-150">
                        Leave
                    </button>
                </div>

                <div class="mb-4 p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-800 text-sm rounded-r-lg shadow-sm">
                    <p class="font-bold">You are chatting as: ${userName}</p>
                </div>

                <!-- Message List -->
                <div id="messages-list" class="chat-message-container space-y-4 p-2">
                    <!-- Messages will be rendered here -->
                    <div class="text-center text-gray-500 pt-8" id="empty-state">
                        Start your conversation in English or Hinglish!
                    </div>
                </div>

                <!-- Message Input -->
                <div class="mt-6">
                    <form id="message-form" class="flex">
                        <input type="text" id="message-input" placeholder="Type your English/Hinglish message..." class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-yellow-500 focus:border-yellow-500" required>
                        <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-r-lg transition duration-200 flex items-center">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            `;
            
            // Note: The call to createIcons is now in renderState to process these new elements.

            document.getElementById('leave-room-btn').addEventListener('click', () => {
                sendSystemMessage(currentRoomCode, 'LEFT').then(() => {
                    currentRoomCode = '';
                    messages = [];
                    appState = 'ROOM_SELECTION'; // Go back to room selection
                    renderState();
                });
            });

            document.getElementById('message-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                translateAndSendMessage(input.value);
            });
            
            renderChatMessages(); // Initial render of messages
        }

        function renderChatMessages() {
            const list = document.getElementById('messages-list');
            if (!list) return; // Guard for non-chat state

            if (messages.length === 0) {
                document.getElementById('empty-state')?.classList.remove('hidden');
                list.innerHTML = `<div class="text-center text-gray-500 pt-8" id="empty-state">Start your conversation in English or Hinglish!</div>`;
                return;
            }
            document.getElementById('empty-state')?.classList.add('hidden');


            list.innerHTML = messages.map(msg => {
                // 1. Handle system messages (Join/Leave)
                if (msg.type === 'system') {
                    return `
                        <div class="text-center my-3">
                            <span class="text-sm text-blue-600 font-medium bg-blue-100 py-1 px-3 rounded-full shadow-sm">
                                ${msg.text}
                            </span>
                        </div>
                    `;
                }

                // 2. Handle user messages
                const isMine = msg.userId === userId;
                
                // Display name or a truncated ID as fallback
                const displayName = isMine ? 'You' : msg.userName || 'Guest'; 
                const userColor = isMine ? 'text-orange-500' : 'text-blue-500';

                return `
                    <div class="flex ${isMine ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs md:max-w-md w-fit p-3 rounded-xl shadow-md ${isMine ? 'bg-orange-100 border-2 border-orange-300' : 'bg-white border-2 border-gray-200'}">
                            <!-- User Name/ID -->
                            <p class="text-xs font-semibold mb-1 ${userColor}">${displayName}</p>

                            <!-- Original Message (English/Hinglish) -->
                            <p class="text-sm text-gray-700 italic border-b pb-1 mb-1">
                                ${msg.originalText}
                            </p>

                            <!-- Translated Sanskrit Message (Primary Focus) -->
                            <p class="text-xl font-extrabold text-black">
                                ${msg.sanskritText}
                            </p>
                            
                            <!-- Timestamp -->
                            <p class="text-[10px] text-gray-400 mt-1 text-right">
                                ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '...'}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to the bottom on new message
            list.scrollTop = list.scrollHeight;
        }

        function copyToClipboard(text, buttonId) {
            const button = document.getElementById(buttonId);
            const originalText = button.innerHTML;
            
            // Use execCommand for broader compatibility in iframes
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Ensure it's not visible
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                button.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i> Copied!'; 
                button.classList.add('bg-green-500');
                button.classList.remove('bg-blue-400');
                createIcons({ icons: lucideIcons });
            } catch (err) {
                console.error('Copy failed:', err);
                button.innerHTML = 'Failed';
                button.classList.add('bg-red-500');
            } finally {
                document.body.removeChild(textarea);
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('bg-green-500', 'bg-red-500');
                    button.classList.add('bg-blue-400');
                    createIcons({ icons: lucideIcons });
                }, 2000);
            }
        }

        // --- Start Application ---
        showLoading();
        initializeFirebase().then(() => {
            hideLoading();
        });

    </script>
</body>
</html>

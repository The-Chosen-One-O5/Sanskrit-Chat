<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanskrit Universal Chat</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Translate and chat in real-time! Create public or private rooms and communicate in Sanskrit, English, or Hinglish with instant, accurate translation." />
    <meta name="keywords" content="Sanskrit chat, English to Sanskrit translator, Hinglish to Sanskrit, real-time chat, language learning, PWA" />

    <!-- Google Site Verification Tag -->
    <meta name="google-site-verification" content="HDarr-udV7HA1nbtNGThOAuP24ObkaQVnu37SEGJJag" />
    
    <!-- PWA & Icon Meta Tags -->
    <meta name="theme-color" content="#FACC15"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sanskrit Chat" />

    <!-- Favicon Links -->
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- Manifest Link (Updated path from manifest.json to /site.webmanifest) -->
    <link rel="manifest" href="/site.webmanifest" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --color-primary: #FACC15; /* Yellow */
            --color-orange: #F97316; /* Orange */
            --color-blue: #3B82F6; /* Blue */
            --color-red: #EF4444; /* Red */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .card {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 500px;
        }
        .chat-message-container {
            max-height: 60vh; /* Adjusted for better visibility */
            overflow-y: auto;
        }
        .chat-message-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-message-container::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 4px;
        }
        .room-list-item {
            cursor: pointer;
        }
        .room-list-item:hover {
            background-color: #fffbeb; /* Light yellow hover */
        }
        .image-message-thumbnail {
            transition: transform 0.2s;
        }
        .image-message-thumbnail:hover {
            transform: scale(1.02);
        }
        #drop-overlay {
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="app-container">

    <div id="app" class="card rounded-xl p-6 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-black mb-6 text-center">
            <span class="text-yellow-600">Sanskrit</span> Universal Chat
        </h1>

        <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto"></div>
                <p class="mt-4 text-gray-700 font-semibold">Loading...</p>
            </div>
        </div>
        
        <div id="alert-message-box" class="hidden mb-4 p-3 border-l-4 rounded-r-lg" role="alert">
            <div class="flex items-center">
                <span id="alert-icon"></span>
                <span id="alert-text" class="font-medium ml-2"></span>
            </div>
        </div>

        <div id="main-view-container"></div>
    </div>

    <script type="module">
        // --- LUCIDE ICONS ---
        import { createIcons, Search, MessageSquare, Plus, LogIn, Send, Copy, AlertTriangle, Check, CheckCheck, List, Zap, Trash2, X, Info, Image, Download, ZoomIn, ZoomOut } from 'https://esm.sh/lucide@latest';
        const lucideIcons = { Search, MessageSquare, Plus, LogIn, Send, Copy, AlertTriangle, Check, CheckCheck, List, Zap, Trash2, X, Info, Image, Download, ZoomIn, ZoomOut };

        // --- FIREBASE SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, getDoc, setDoc, where, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONSTANTS ---
        // Vercel Serverless Function Endpoint for Translation
        const TRANSLATION_ENDPOINT = "/api/translate"; 
        // 24 hours in milliseconds for inactivity check
        const INACTIVITY_LIMIT_MS = 24 * 60 * 60 * 1000; 
        const USER_NAME_STORAGE_KEY = 'sanskrit_chat_user_name';
        
        // Firebase Config Fallback (User provided)
        const USER_PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDK_RPUQaQ86dzRhOOrrzRvRcG5pMyHR_E",
            authDomain: "sanskrit-chat.firebaseapp.com",
            projectId: "sanskrit-chat",
            storageBucket: "sanskrit-chat.firebasestorage.app",
            messagingSenderId: "328437332405",
            appId: "1:328437332405:web:ffd31f848b2351501fc1fc",
            measurementId: "G-X14R907GQB"
        };
        
        // --- APPLICATION STATE CONSTANTS ---
        const STATE = {
            NAME_INPUT: 'NAME_INPUT',
            ROOM_HUB: 'ROOM_HUB',
            CREATE_ROOM_FORM: 'CREATE_ROOM_FORM',
            JOIN_CODE_FORM: 'JOIN_CODE_FORM',
            CHAT: 'CHAT'
        };

        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sanskrit-chat-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let storage;
        let userId = null;
        let userName = '';
        let currentState = STATE.NAME_INPUT;
        let currentRoomCode = '';
        let currentRoomData = null; // Store room metadata for host check
        let messages = [];
        let publicRooms = [];
        let unsubscribePublicRooms = null; 
        let unsubscribeChat = null; 
        let messageObserver = null;
        let visibleMessages = new Set();

        // DOM elements
        const mainViewContainer = document.getElementById('main-view-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const alertMessageBox = document.getElementById('alert-message-box');
        const alertText = document.getElementById('alert-text');
        const alertIcon = document.getElementById('alert-icon');


        // --- UTILITY FUNCTIONS ---

        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function alertMessage(message, type = 'error') {
            const classMap = {
                'error': { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-700', icon: 'alert-triangle' },
                'info': { bg: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-700', icon: 'list' },
            };
            
            const config = classMap[type] || classMap['error'];
            
            alertMessageBox.className = `mb-4 p-3 border-l-4 ${config.bg} ${config.border} ${config.text} rounded-r-lg`;
            alertText.textContent = message;
            alertIcon.innerHTML = `<i data-lucide="${config.icon}" class="w-5 h-5 mr-2"></i>`;
            alertMessageBox.classList.remove('hidden');
            
            // Re-render icons for the alert box
            createIcons({ icons: lucideIcons, attrs: { color: config.text.replace('text-', '') }});

            setTimeout(() => {
                alertMessageBox.classList.add('hidden');
            }, 5000);
        }
        
        function showError(message) {
            alertMessage(message, 'error');
        }

        function switchState(newState) {
            console.log(`Switching state: ${currentState} -> ${newState}`);
            currentState = newState;
            renderState();
        }
        
        // --- FIREBASE INITIALIZATION AND AUTH ---

        async function initializeFirebase() {
            showLoading();
            
            // Load user name from local storage if available
            const storedName = localStorage.getItem(USER_NAME_STORAGE_KEY);
            if (storedName) {
                userName = storedName;
            }

            let firebaseConfig = USER_PROVIDED_FIREBASE_CONFIG;
            if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '') {
                try {
                    const envConfig = JSON.parse(__firebase_config);
                    if (envConfig.projectId) {
                        firebaseConfig = envConfig;
                    }
                } catch (e) {
                    console.warn("Could not parse __firebase_config, using hardcoded fallback.");
                }
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                userId = auth.currentUser.uid;
                            } catch (e) {
                                console.error("Anonymous/Custom sign-in failed:", e);
                                showError("Authentication failed. Cannot connect to chat.");
                                return;
                            }
                        }
                        console.log("Authentication successful. User ID:", userId);
                        resolve();
                    });
                });
                
                // Determine initial state based on persistent name
                if (userName) {
                    switchState(STATE.ROOM_HUB);
                } else {
                    switchState(STATE.NAME_INPUT);
                }
                
            } catch (error) {
                console.error("Fatal Error initializing Firebase:", error);
                showError("Fatal Error: Could not initialize app or connect to database.");
            } finally {
                hideLoading();
            }
        }
        
        // --- INACTIVITY CHECK & CLEANUP ---

        async function deleteExpiredRoom(roomCode) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode);
            try {
                await deleteDoc(roomRef);
                console.log(`Room ${roomCode} deleted due to inactivity.`);
            } catch (e) {
                // Ignore permission denied if the room was already deleted by another client
                console.warn(`Failed to delete expired room ${roomCode}:`, e.message);
            }
        }


        // --- REAL-TIME LISTENERS & ROOM LOGIC ---

        function setupPublicRoomListener() {
            if (unsubscribePublicRooms) {
                unsubscribePublicRooms();
                unsubscribePublicRooms = null;
            }
            if (!db) return;

            const roomsRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`);
            // Query only for public rooms. We must sort client-side.
            const publicRoomsQuery = query(roomsRef, where("isPublic", "==", true)); 

            unsubscribePublicRooms = onSnapshot(publicRoomsQuery, (snapshot) => {
                publicRooms = [];
                const now = Date.now();

                snapshot.forEach(doc => {
                    const room = { id: doc.id, ...doc.data() };
                    
                    // Client-Side Inactivity Check: Check if room is older than 24 hours (INACTIVITY_LIMIT_MS)
                    const createdAtTime = room.createdAt?.toDate().getTime() || 0;
                    const isExpired = now - createdAtTime > INACTIVITY_LIMIT_MS;

                    if (isExpired) {
                        // Trigger deletion if the room is too old, but don't add it to the list
                        deleteExpiredRoom(room.id); 
                    } else {
                        publicRooms.push(room);
                    }
                });
                
                // Client-side sort by creation time (newest first)
                publicRooms.sort((a, b) => {
                    const timeA = a.createdAt?.toDate().getTime() || 0;
                    const timeB = b.createdAt?.toDate().getTime() || 0;
                    return timeB - timeA;
                });

                if (currentState === STATE.ROOM_HUB) {
                    renderRoomHub();
                }
            }, (error) => {
                console.error("Error listening to public rooms:", error);
                alertMessage("Failed to load public rooms list.", 'info');
            });
        }
        
        function listenToChat(roomCode) {
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            if (!db || !roomCode) return;

            const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode, 'messages');
            const messagesQuery = query(messagesRef, orderBy('timestamp', 'asc'));

            unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
                messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                if (currentState === STATE.CHAT) {
                    renderChatMessages();
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
                showError("Real-time connection lost. Check your network.");
                if (error.code === 'not-found' || error.code === 'permission-denied') {
                    alertMessage("The room you were in was closed by the host or no longer exists.", 'info');
                    switchState(STATE.ROOM_HUB);
                }
            });
        }
        
        function cleanupListeners() {
            if (unsubscribePublicRooms) {
                unsubscribePublicRooms();
            }
            if (unsubscribeChat) {
                unsubscribeChat();
            }
            if (messageObserver) {
                messageObserver.disconnect();
            }
            unsubscribePublicRooms = null;
            unsubscribeChat = null;
            messageObserver = null;
            visibleMessages.clear();
            currentRoomData = null;
        }


        // --- SYSTEM MESSAGE SENDER ---
        async function sendSystemMessage(roomCode, type) {
            try {
                if (!db || !userName) throw new Error("Database or user name not ready.");
                const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode, 'messages');

                await addDoc(messagesRef, {
                    type: 'system',
                    text: `${userName} has ${type.toLowerCase()} the chat.`,
                    userName: userName,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Failed to send system message:", e);
            }
        }

        // --- ROOM ACTIONS ---

        async function createRoom(roomName, isPublic) {
            showLoading();
            const newCode = generateRoomCode();
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, newCode);
            try {
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.exists()) {
                    hideLoading();
                    return createRoom(roomName, isPublic);
                }

                const newRoomData = { 
                    createdAt: serverTimestamp(), 
                    hostId: userId,
                    hostName: userName,
                    roomName: roomName,
                    isPublic: isPublic
                };

                await setDoc(roomRef, newRoomData);
                
                currentRoomCode = newCode;
                currentRoomData = newRoomData; // Store new room data
                switchState(STATE.CHAT);
                listenToChat(newCode);
                sendSystemMessage(newCode, 'JOINED');

            } catch (e) {
                console.error("Error creating room:", e);
                showError("Failed to create room. Database error.");
            } finally {
                hideLoading();
            }
        }

        async function joinRoom(code) {
            code = code.toUpperCase().trim();
            if (!code || code.length !== 6) {
                showError("Invalid room code. It must be 6 characters.");
                return;
            }

            showLoading();
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, code);

            try {
                const roomSnap = await getDoc(roomRef);
                if (!roomSnap.exists()) {
                    showError(`Room '${code}' not found. Check the code.`);
                    return;
                }
                
                // Check for expiration immediately upon attempting to join
                const roomData = roomSnap.data();
                const createdAtTime = roomData.createdAt?.toDate().getTime() || 0;
                const isExpired = Date.now() - createdAtTime > INACTIVITY_LIMIT_MS;

                if (isExpired) {
                    await deleteExpiredRoom(code);
                    showError(`Room '${code}' was too old and has been deleted.`);
                    return;
                }

                currentRoomCode = code;
                currentRoomData = roomData; // Store joined room data
                switchState(STATE.CHAT);
                listenToChat(code);
                sendSystemMessage(code, 'JOINED');

            } catch (e) {
                console.error("Error joining room:", e);
                showError("Failed to join room. Database error.");
            } finally {
                hideLoading();
            }
        }
        
        async function deleteRoom() {
            if (currentRoomData.hostId !== userId) {
                showError("Permission denied. Only the room host can delete this room.");
                return;
            }

            showLoading();
            const roomCodeToDelete = currentRoomCode;
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCodeToDelete);

            try {
                await deleteDoc(roomRef);
                
                currentRoomCode = '';
                currentRoomData = null;
                messages = [];
                switchState(STATE.ROOM_HUB);
                alertMessage(`Room ${roomCodeToDelete} has been successfully deleted.`, 'info');

            } catch (e) {
                console.error("Error deleting room:", e);
                showError("Failed to delete room. Check Firebase Security Rules.");
            } finally {
                hideLoading();
            }
        }
        
        function generateRoomCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }
        
        // --- TRANSLATION LOGIC (Calls secure endpoint) ---
        
        async function callGroqApi(prompt) {
            const maxRetries = 3;
            let lastError = null;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(TRANSLATION_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });

                    if (!response.ok) {
                        const errorText = await response.text().catch(() => '');
                        throw new Error(`Endpoint error ${response.status}: ${errorText || response.statusText}`);
                    }

                    const clone = response.clone();
                    let data;
                    try {
                        data = await response.json();
                    } catch (err) {
                        const raw = await clone.text().catch(() => '');
                        throw new Error(`Invalid JSON from server: ${raw.slice(0, 200)}`);
                    }
                    const translatedText = data.sanskritText || data.text || data.response || data.content;
                    
                    if (!translatedText) {
                        throw new Error("API response was empty or malformed.");
                    }
                    
                    console.log(`Translation successful via ${data.provider || 'unknown provider'} (Groq/Cerebras)`);
                    return String(translatedText);

                } catch (e) {
                    lastError = e;
                    console.warn(`Translation attempt ${attempt + 1} failed: ${e.message}`);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
            throw new Error(`Translation failed after ${maxRetries} attempts using Groq/Cerebras. ${lastError?.message || lastError}`);
        }

        async function translateAndSendMessage(originalText) {
            if (!originalText.trim()) return;

            showLoading();
            let sanskritText = "Translation failed.";

            try {
                sanskritText = await callGroqApi(originalText);
                
            } catch (e) {
                console.error("Translation error:", e);
                showError(`Sanskrit translation failed: ${e.message}`);
                sanskritText = `[Translation Error] ${originalText}`; 
            }

            try {
                if (!db || !currentRoomCode) throw new Error("Chat not initialized.");
                const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, currentRoomCode, 'messages');

                await addDoc(messagesRef, {
                    originalText: originalText,
                    sanskritText: sanskritText,
                    userId: userId,
                    userName: userName,
                    type: 'user',
                    timestamp: serverTimestamp(),
                    readBy: {}
                });

                document.getElementById('message-input').value = '';
                
            } catch (e) {
                console.error("Failed to send message:", e);
                showError("Could not send message to the room.");
            } finally {
                hideLoading();
            }
        }

        // --- IMAGE SHARING FUNCTIONS ---

        async function compressImage(file, maxWidth = 1920, quality = 0.85) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new window.Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Failed to compress image'));
                            }
                        }, file.type === 'image/png' ? 'image/png' : 'image/jpeg', quality);
                    };
                    img.onerror = () => reject(new Error('Failed to load image'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        async function generateThumbnail(file, maxSize = 300) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new window.Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxSize) {
                                height = (height * maxSize) / width;
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = (width * maxSize) / height;
                                height = maxSize;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                resolve(blob);
                            } else {
                                reject(new Error('Failed to generate thumbnail'));
                            }
                        }, 'image/jpeg', 0.7);
                    };
                    img.onerror = () => reject(new Error('Failed to load image for thumbnail'));
                    img.src = e.target.result;
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        async function uploadImageMessage(file) {
            if (!file) return;

            const validTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                showError('Please select a valid image file (JPEG, PNG, WebP, or GIF)');
                return;
            }

            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                showError('Image file is too large. Maximum size is 10MB.');
                return;
            }

            showLoading();

            try {
                const timestamp = Date.now();
                const originalFileName = file.name;

                const compressedBlob = await compressImage(file);
                const thumbnailBlob = await generateThumbnail(file);

                const imagePath = `rooms/${currentRoomCode}/images/${timestamp}-${userId}`;
                const thumbnailPath = `rooms/${currentRoomCode}/images/thumbnails/${timestamp}-${userId}`;

                const imageRef = ref(storage, imagePath);
                const thumbnailRef = ref(storage, thumbnailPath);

                await uploadBytes(imageRef, compressedBlob, {
                    contentType: file.type,
                    customMetadata: {
                        originalFileName: originalFileName,
                        uploadedBy: userId,
                        userName: userName
                    }
                });

                await uploadBytes(thumbnailRef, thumbnailBlob, {
                    contentType: 'image/jpeg'
                });

                const imageUrl = await getDownloadURL(imageRef);
                const thumbnailUrl = await getDownloadURL(thumbnailRef);

                const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, currentRoomCode, 'messages');

                await addDoc(messagesRef, {
                    type: 'image',
                    imageUrl: imageUrl,
                    thumbnailUrl: thumbnailUrl,
                    originalFileName: originalFileName,
                    fileSize: compressedBlob.size,
                    userId: userId,
                    userName: userName,
                    timestamp: serverTimestamp(),
                    readBy: {}
                });

                console.log('Image uploaded successfully');

            } catch (e) {
                console.error('Failed to upload image:', e);
                showError(`Failed to upload image: ${e.message}`);
            } finally {
                hideLoading();
            }
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadImageMessage(file);
            }
            event.target.value = '';
        }

        function openImageLightbox(imageUrl, fileName) {
            const modal = document.createElement('div');
            modal.id = 'image-lightbox-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50';
            
            let scale = 1;
            let translateX = 0;
            let translateY = 0;
            let isDragging = false;
            let startX = 0;
            let startY = 0;

            modal.innerHTML = `
                <div class="relative w-full h-full flex flex-col">
                    <div class="absolute top-4 right-4 flex gap-2 z-10">
                        <button id="zoom-out-btn" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black font-bold p-3 rounded-full shadow-lg transition">
                            <i data-lucide="zoom-out" class="w-5 h-5"></i>
                        </button>
                        <button id="zoom-in-btn" class="bg-white bg-opacity-80 hover:bg-opacity-100 text-black font-bold p-3 rounded-full shadow-lg transition">
                            <i data-lucide="zoom-in" class="w-5 h-5"></i>
                        </button>
                        <a id="download-image-btn" href="${imageUrl}" download="${fileName}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-3 rounded-full shadow-lg transition flex items-center">
                            <i data-lucide="download" class="w-5 h-5"></i>
                        </a>
                        <button id="close-lightbox-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold p-3 rounded-full shadow-lg transition">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="flex-1 flex justify-center items-center overflow-hidden p-4">
                        <img id="lightbox-image" src="${imageUrl}" alt="${fileName}" class="max-w-full max-h-full object-contain cursor-move transition-transform" style="transform: scale(${scale}) translate(${translateX}px, ${translateY}px);" />
                    </div>
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-white bg-opacity-80 px-4 py-2 rounded-full">
                        <p class="text-sm font-medium text-black">${fileName}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            createIcons({ icons: lucideIcons });

            const lightboxImage = document.getElementById('lightbox-image');

            function updateTransform() {
                lightboxImage.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
            }

            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                scale = Math.min(scale + 0.25, 3);
                updateTransform();
            });

            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                scale = Math.max(scale - 0.25, 0.5);
                updateTransform();
            });

            document.getElementById('close-lightbox-btn').addEventListener('click', () => {
                modal.remove();
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            lightboxImage.addEventListener('mousedown', (e) => {
                if (scale > 1) {
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    lightboxImage.style.cursor = 'grabbing';
                }
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    updateTransform();
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    lightboxImage.style.cursor = 'move';
                }
            });

            lightboxImage.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (e.deltaY < 0) {
                    scale = Math.min(scale + 0.1, 3);
                } else {
                    scale = Math.max(scale - 0.1, 0.5);
                }
                updateTransform();
            });
        }

        // --- READ RECEIPTS LOGIC ---

        async function markMessageAsRead(messageId) {
            if (!db || !currentRoomCode || !userId) return;
            
            const messageRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, currentRoomCode, 'messages', messageId);
            try {
                await updateDoc(messageRef, {
                    [`readBy.${userId}`]: serverTimestamp()
                });
            } catch (e) {
                console.error("Failed to mark message as read:", e);
            }
        }

        function setupMessageVisibilityObserver() {
            if (messageObserver) {
                messageObserver.disconnect();
            }

            const options = {
                root: document.getElementById('messages-list'),
                threshold: 0.5
            };

            messageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const messageId = entry.target.getAttribute('data-message-id');
                    const senderId = entry.target.getAttribute('data-sender-id');
                    
                    if (entry.isIntersecting && messageId && senderId !== userId) {
                        if (!visibleMessages.has(messageId)) {
                            visibleMessages.add(messageId);
                            markMessageAsRead(messageId);
                        }
                    }
                });
            }, options);

            document.querySelectorAll('.chat-message').forEach(msgEl => {
                messageObserver.observe(msgEl);
            });
        }

        function getReadStatus(message) {
            if (!message.readBy) return 'delivered';
            
            const readByCount = Object.keys(message.readBy).length;
            if (readByCount === 0) return 'delivered';
            
            const roomParticipants = new Set();
            messages.forEach(msg => {
                if (msg.type === 'user' && msg.userId && msg.userId !== message.userId) {
                    roomParticipants.add(msg.userId);
                }
            });
            
            const participantCount = roomParticipants.size;
            if (participantCount === 0) return 'read-partial';
            
            const readByParticipants = Object.keys(message.readBy).filter(uid => uid !== message.userId);
            if (readByParticipants.length >= participantCount) {
                return 'read-all';
            }
            
            return 'read-partial';
        }

        function getReadStatusIcon(status) {
            if (status === 'delivered') {
                return '<i data-lucide="check" class="w-3 h-3 text-gray-400"></i>';
            } else if (status === 'read-partial') {
                return '<i data-lucide="check-check" class="w-3 h-3 text-gray-400"></i>';
            } else if (status === 'read-all') {
                return '<i data-lucide="check-check" class="w-3 h-3 text-blue-500"></i>';
            }
            return '';
        }

        function showMessageInfo(message) {
            const readByEntries = message.readBy ? Object.entries(message.readBy) : [];
            const readByList = readByEntries.length > 0
                ? readByEntries.map(([uid, timestamp]) => {
                    const userName = messages.find(m => m.userId === uid)?.userName || 'Unknown User';
                    const readTime = timestamp?.toDate ? timestamp.toDate().toLocaleString() : 'Just now';
                    return `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200">
                            <div>
                                <p class="font-semibold text-gray-800">${userName}</p>
                                <p class="text-xs text-gray-500">${uid === userId ? '(You)' : ''}</p>
                            </div>
                            <p class="text-xs text-gray-600">${readTime}</p>
                        </div>
                    `;
                }).join('')
                : '<p class="text-center text-gray-500 py-4">No read receipts yet</p>';

            const sentTime = message.timestamp?.toDate ? message.timestamp.toDate().toLocaleString() : 'Sending...';
            const status = getReadStatus(message);
            const statusText = status === 'delivered' ? 'Delivered' : status === 'read-all' ? 'Read by all' : 'Read by some';

            const modal = document.createElement('div');
            modal.id = 'message-info-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md w-11/12 shadow-2xl">
                    <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center">
                            <i data-lucide="info" class="w-5 h-5 mr-2 text-blue-500"></i>
                            Message Info
                        </h3>
                        <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-600 mb-1">Message</p>
                        <p class="text-sm text-gray-800 italic">${message.originalText}</p>
                        <p class="text-base font-bold text-gray-900 mt-1">${message.sanskritText}</p>
                    </div>

                    <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-600">Sent:</span>
                            <span class="font-semibold text-gray-800">${sentTime}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Status:</span>
                            <span class="font-semibold text-gray-800">${statusText}</span>
                        </div>
                    </div>

                    <div class="mb-2">
                        <h4 class="text-sm font-bold text-gray-700 mb-2 flex items-center">
                            <i data-lucide="check-check" class="w-4 h-4 mr-1 text-blue-500"></i>
                            Read by (${readByEntries.length})
                        </h4>
                        <div class="max-h-48 overflow-y-auto">
                            ${readByList}
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            createIcons({ icons: lucideIcons });

            document.getElementById('close-modal-btn').addEventListener('click', () => {
                modal.remove();
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // --- UI RENDERERS ---

        function renderState() {
            mainViewContainer.innerHTML = '';
            
            if (currentState !== STATE.ROOM_HUB) {
                cleanupListeners();
            }

            switch (currentState) {
                case STATE.NAME_INPUT:
                    renderNameInput();
                    break;
                case STATE.ROOM_HUB:
                    renderRoomHub();
                    setupPublicRoomListener();
                    break;
                case STATE.CREATE_ROOM_FORM:
                    renderCreateRoomForm();
                    break;
                case STATE.JOIN_CODE_FORM:
                    renderJoinCodeForm();
                    break;
                case STATE.CHAT:
                    renderChat();
                    break;
                default:
                    renderNameInput();
            }
            createIcons({ icons: lucideIcons });
        }

        function renderNameInput() {
            mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Welcome to Sanskrit Chat!</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">First, enter your name to begin.</p>
                <input id="user-name-input" type="text" placeholder="Your Name" maxlength="20" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg mb-4">
                <button id="set-name-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    Continue
                </button>
            `;
            document.getElementById('set-name-btn').addEventListener('click', () => {
                const name = document.getElementById('user-name-input').value.trim();
                if (name) {
                    userName = name.substring(0, 20);
                    localStorage.setItem(USER_NAME_STORAGE_KEY, userName); // Save name
                    switchState(STATE.ROOM_HUB);
                } else {
                    showError("Please enter a name.");
                }
            });
        }
        
        function renderRoomHub() {
            const listItems = publicRooms.length > 0
                ? publicRooms.map(room => `
                    <div class="room-list-item p-3 border-b border-gray-200 flex justify-between items-center bg-white shadow-sm rounded-lg mb-2" data-room-code="${room.id}">
                        <div>
                            <p class="font-semibold text-gray-800">${room.roomName || 'Untitled Public Room'}</p>
                            <p class="text-xs text-gray-500">Host: ${room.hostName || 'Anonymous'}</p>
                        </div>
                        <button class="bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-full hover:bg-blue-600">
                            Join
                        </button>
                    </div>
                `).join('')
                : '<p class="text-center text-gray-500 py-4">No public rooms available. Be the first to create one!</p>';

            mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Welcome to the Hub, ${userName}!</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">Browse public rooms or create your own.</p>
                
                <div class="bg-gray-50 p-3 rounded-lg max-h-60 overflow-y-auto mb-6 border border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 flex items-center text-gray-700 border-b pb-2">
                        <i data-lucide="list" class="w-5 h-5 mr-2 text-yellow-600"></i>
                        Active Public Rooms
                    </h3>
                    <div id="public-room-list">
                        ${listItems}
                    </div>
                </div>

                <div class="space-y-3">
                    <button id="create-room-nav-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Create a New Room
                    </button>
                    <button id="join-code-nav-btn" class="w-full flex items-center justify-center bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                        Join Private by Code
                    </button>
                </div>
            `;
            
            document.getElementById('create-room-nav-btn').addEventListener('click', () => switchState(STATE.CREATE_ROOM_FORM));
            document.getElementById('join-code-nav-btn').addEventListener('click', () => switchState(STATE.JOIN_CODE_FORM));

            document.querySelectorAll('.room-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const roomCode = item.getAttribute('data-room-code');
                    joinRoom(roomCode);
                });
            });
        }

        function renderCreateRoomForm() {
            mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-6 text-center">Create Your Room</h2>

                <label for="room-name-input" class="block text-sm font-medium text-gray-700 mb-1">Room Name</label>
                <input id="room-name-input" type="text" placeholder="e.g., Sanskrit Practice Group" maxlength="30" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg mb-4">
                
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-6 border border-gray-200">
                    <label for="is-public-toggle" class="text-sm font-medium text-gray-700">Make this room public (Listed in Hub)</label>
                    <input type="checkbox" id="is-public-toggle" class="form-checkbox h-5 w-5 text-yellow-500 rounded border-gray-300 focus:ring-yellow-500" checked>
                </div>

                <button id="create-room-action-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                    Start Chat & Get Code
                </button>
                <button id="back-to-hub-btn" class="w-full mt-3 text-sm text-gray-500 hover:text-gray-700 p-2">
                    Back to Room Hub
                </button>
            `;
            document.getElementById('create-room-action-btn').addEventListener('click', () => {
                const roomName = document.getElementById('room-name-input').value.trim() || 'Untitled Room';
                const isPublic = document.getElementById('is-public-toggle').checked;
                createRoom(roomName, isPublic);
            });
            document.getElementById('back-to-hub-btn').addEventListener('click', () => switchState(STATE.ROOM_HUB));
        }

        function renderJoinCodeForm() {
             mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Join a Private Room</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">Enter the 6-character code shared by the host.</p>
                <input id="room-code-input" type="text" placeholder="e.g., ABC123" maxlength="6" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 text-lg uppercase mb-4 text-center tracking-widest font-mono">
                <button id="join-room-action-btn" class="w-full flex items-center justify-center bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                    Connect to Chat
                </button>
                <button id="back-to-hub-btn" class="w-full mt-3 text-sm text-gray-500 hover:text-gray-700 p-2">
                    Back to Room Hub
                </button>
            `;
            document.getElementById('join-room-action-btn').addEventListener('click', () => {
                const code = document.getElementById('room-code-input').value;
                joinRoom(code);
            });
            document.getElementById('back-to-hub-btn').addEventListener('click', () => switchState(STATE.ROOM_HUB));
        }

        function renderChat() {
            // Check if current user is the host
            const isHost = currentRoomData && currentRoomData.hostId === userId;
            const deleteButtonHtml = isHost ? `
                <div id="delete-actions" class="mt-4 flex flex-col items-center">
                    <button id="show-delete-confirm-btn" class="text-sm text-red-500 hover:text-red-700 font-semibold p-1 transition duration-150 flex items-center">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i>
                        Delete Room
                    </button>
                    <div id="delete-confirm-box" class="hidden mt-2 p-3 bg-red-100 border border-red-400 rounded-lg shadow-md text-sm w-full">
                        <p class="text-red-700 font-medium mb-2">Are you sure? This action is permanent.</p>
                        <div class="flex justify-around">
                            <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md transition duration-150">
                                Yes, Delete
                            </button>
                            <button id="cancel-delete-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-md transition duration-150">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            mainViewContainer.innerHTML = `
                <div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-yellow-500">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="message-square" class="w-6 h-6 mr-2 text-orange-500"></i>
                        ${currentRoomData?.roomName || 'Chat Room'}
                    </h2>
                    <button id="leave-room-btn" class="text-sm text-red-500 hover:text-red-700 font-semibold p-1 transition duration-150">
                        Leave
                    </button>
                </div>

                <div class="mb-4 p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-800 text-sm rounded-r-lg shadow-sm">
                    <p class="font-bold">Chatting as: ${userName} (Room Code: ${currentRoomCode})</p>
                </div>
                
                ${deleteButtonHtml}

                <div id="messages-list" class="chat-message-container space-y-4 p-2" style="position: relative;">
                    <div class="text-center text-gray-500 pt-8" id="empty-state">
                        Start your conversation in English or Hinglish!
                    </div>
                    <div id="drop-overlay" class="hidden fixed inset-0 bg-blue-500 bg-opacity-20 border-4 border-dashed border-blue-500 flex justify-center items-center z-40 pointer-events-none">
                        <div class="bg-white p-6 rounded-xl shadow-2xl">
                            <i data-lucide="image" class="w-16 h-16 mx-auto text-blue-500 mb-2"></i>
                            <p class="text-xl font-bold text-gray-800">Drop image here to upload</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <form id="message-form" class="flex gap-2">
                        <input type="text" id="message-input" placeholder="Type your English/Hinglish message..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500" required>
                        <input type="file" id="image-input" accept="image/jpeg,image/png,image/webp,image/gif" class="hidden">
                        <button type="button" id="image-upload-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center">
                            <i data-lucide="image" class="w-5 h-5"></i>
                        </button>
                        <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            `;
            
            document.getElementById('leave-room-btn').addEventListener('click', () => {
                sendSystemMessage(currentRoomCode, 'LEFT').then(() => {
                    switchState(STATE.ROOM_HUB);
                });
            });

            document.getElementById('message-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                translateAndSendMessage(input.value);
            });

            document.getElementById('image-upload-btn').addEventListener('click', () => {
                document.getElementById('image-input').click();
            });

            document.getElementById('image-input').addEventListener('change', handleImageSelect);

            const dropOverlay = document.getElementById('drop-overlay');
            const appContainer = document.getElementById('app');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                appContainer.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                appContainer.addEventListener(eventName, () => {
                    dropOverlay.classList.remove('hidden');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                appContainer.addEventListener(eventName, () => {
                    dropOverlay.classList.add('hidden');
                }, false);
            });

            appContainer.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        uploadImageMessage(file);
                    } else {
                        showError('Please drop an image file');
                    }
                }
            }, false);
            
            // Host deletion logic setup
            if (isHost) {
                const showDeleteBtn = document.getElementById('show-delete-confirm-btn');
                const deleteConfirmBox = document.getElementById('delete-confirm-box');
                const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

                showDeleteBtn.addEventListener('click', () => {
                    deleteConfirmBox.classList.remove('hidden');
                    showDeleteBtn.classList.add('hidden');
                });
                
                cancelDeleteBtn.addEventListener('click', () => {
                    deleteConfirmBox.classList.add('hidden');
                    showDeleteBtn.classList.remove('hidden');
                });

                confirmDeleteBtn.addEventListener('click', deleteRoom);
            }

            renderChatMessages(); 
        }

        function renderChatMessages() {
            const list = document.getElementById('messages-list');
            if (!list) return;

            if (messages.length === 0) {
                document.getElementById('empty-state')?.classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state')?.classList.add('hidden');

            list.innerHTML = messages.map(msg => {
                // 1. System messages
                if (msg.type === 'system') {
                    return `
                        <div class="text-center my-3">
                            <span class="text-sm text-blue-600 font-medium bg-blue-100 py-1 px-3 rounded-full shadow-sm">
                                ${msg.text}
                            </span>
                        </div>
                    `;
                }

                const isMine = msg.userId === userId;
                const displayName = isMine ? 'You' : msg.userName || 'Guest'; 
                const userColor = isMine ? 'text-orange-500' : 'text-blue-500';
                
                const status = getReadStatus(msg);
                const statusIcon = getReadStatusIcon(status);
                const readReceipt = isMine && statusIcon ? `<span class="inline-block ml-1">${statusIcon}</span>` : '';

                // 2. Image messages
                if (msg.type === 'image') {
                    const fileSize = msg.fileSize ? `${(msg.fileSize / 1024).toFixed(1)} KB` : '';
                    return `
                        <div class="flex ${isMine ? 'justify-end' : 'justify-start'} chat-message" data-message-id="${msg.id}" data-sender-id="${msg.userId}">
                            <div class="max-w-xs md:max-w-md w-fit p-3 rounded-xl shadow-md ${isMine ? 'bg-orange-100 border-2 border-orange-300' : 'bg-white border-2 border-gray-200'}">
                                <p class="text-xs font-semibold mb-2 ${userColor}">${displayName}</p>
                                
                                <div class="cursor-pointer image-message-thumbnail" data-image-url="${msg.imageUrl}" data-image-name="${msg.originalFileName}">
                                    <img src="${msg.thumbnailUrl}" alt="${msg.originalFileName}" class="rounded-lg max-w-full h-auto shadow-sm" style="max-height: 300px; object-fit: cover;" loading="lazy" />
                                </div>
                                
                                <p class="text-xs text-gray-600 mt-2 truncate" title="${msg.originalFileName}">
                                    <i data-lucide="image" class="w-3 h-3 inline"></i>
                                    ${msg.originalFileName}
                                </p>
                                ${fileSize ? `<p class="text-xs text-gray-500">${fileSize}</p>` : ''}
                                
                                <div class="flex items-center justify-end mt-1">
                                    <p class="text-[10px] text-gray-400">
                                        ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '...'}
                                    </p>
                                    ${readReceipt}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 3. User text messages
                return `
                    <div class="flex ${isMine ? 'justify-end' : 'justify-start'} chat-message" data-message-id="${msg.id}" data-sender-id="${msg.userId}">
                        <div class="max-w-xs md:max-w-md w-fit p-3 rounded-xl shadow-md ${isMine ? 'bg-orange-100 border-2 border-orange-300 cursor-pointer hover:shadow-lg transition-shadow' : 'bg-white border-2 border-gray-200'}">
                            <p class="text-xs font-semibold mb-1 ${userColor}">${displayName}</p>

                            <p class="text-sm text-gray-700 italic border-b pb-1 mb-1">
                                ${msg.originalText}
                            </p>

                            <p class="text-xl font-extrabold text-black">
                                ${msg.sanskritText}
                            </p>
                            
                            <div class="flex items-center justify-end mt-1">
                                <p class="text-[10px] text-gray-400">
                                    ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '...'}
                                </p>
                                ${readReceipt}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            messages.forEach(msg => {
                if (msg.type === 'user') {
                    const msgElement = list.querySelector(`[data-message-id="${msg.id}"]`);
                    if (msgElement && msg.userId === userId) {
                        msgElement.addEventListener('click', () => showMessageInfo(msg));
                    }
                } else if (msg.type === 'image') {
                    const msgElement = list.querySelector(`[data-message-id="${msg.id}"]`);
                    if (msgElement) {
                        const imageContainer = msgElement.querySelector('[data-image-url]');
                        if (imageContainer) {
                            imageContainer.addEventListener('click', () => {
                                const imageUrl = imageContainer.getAttribute('data-image-url');
                                const imageName = imageContainer.getAttribute('data-image-name');
                                openImageLightbox(imageUrl, imageName);
                            });
                        }
                    }
                }
            });

            list.scrollTop = list.scrollHeight;
            
            createIcons({ icons: lucideIcons });
            
            setTimeout(() => {
                setupMessageVisibilityObserver();
            }, 100);
        }

        // --- START APPLICATION ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>

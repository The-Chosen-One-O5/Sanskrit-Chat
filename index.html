<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanskrit Universal Chat</title>

    <!-- Google Site Verification Tag -->
    <meta name="google-site-verification" content="HDarr-udV7HA1nbtNGThOAuP24ObkaQVnu37SEGJJag" />
    
    <!-- PWA & Icon Meta Tags -->
    <meta name="theme-color" content="#FACC15"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sanskrit Chat" />

    <!-- Favicon Links -->
    <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="shortcut icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    
    <!-- Manifest Link (Updated path from manifest.json to /site.webmanifest) -->
    <link rel="manifest" href="/site.webmanifest" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for aesthetic appeal and responsiveness */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --color-primary: #FACC15; /* Yellow */
            --color-orange: #F97316; /* Orange */
            --color-blue: #3B82F6; /* Blue */
            --color-red: #EF4444; /* Red */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .app-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .card {
            background-color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 90%;
            width: 500px;
        }
        .chat-message-container {
            max-height: 60vh; /* Adjusted for better visibility */
            overflow-y: auto;
        }
        .chat-message-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-message-container::-webkit-scrollbar-thumb {
            background-color: var(--color-primary);
            border-radius: 4px;
        }
        .room-list-item {
            cursor: pointer;
        }
        .room-list-item:hover {
            background-color: #fffbeb; /* Light yellow hover */
        }
    </style>
</head>
<body class="app-container">

    <div id="app" class="card rounded-xl p-6 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-black mb-6 text-center">
            <span class="text-yellow-600">Sanskrit</span> Universal Chat
        </h1>

        <div id="loading-overlay" class="hidden fixed inset-0 bg-white bg-opacity-75 flex justify-center items-center z-50">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-500 mx-auto"></div>
                <p class="mt-4 text-gray-700 font-semibold">Loading...</p>
            </div>
        </div>
        
        <div id="alert-message-box" class="hidden mb-4 p-3 border-l-4 rounded-r-lg" role="alert">
            <div class="flex items-center">
                <span id="alert-icon"></span>
                <span id="alert-text" class="font-medium ml-2"></span>
            </div>
        </div>

        <div id="main-view-container"></div>
    </div>

    <script type="module">
        // --- LUCIDE ICONS ---
        import { createIcons, Search, MessageSquare, Plus, LogIn, Send, Copy, AlertTriangle, Check, List, Zap, Trash2 } from 'https://esm.sh/lucide@latest';
        const lucideIcons = { Search, MessageSquare, Plus, LogIn, Send, Copy, AlertTriangle, Check, List, Zap, Trash2 };

        // --- FIREBASE SDKs ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, getDoc, setDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONSTANTS ---
        // Vercel Serverless Function Endpoint for Translation
        const TRANSLATION_ENDPOINT = "/api/translate"; 
        // 24 hours in milliseconds for inactivity check
        const INACTIVITY_LIMIT_MS = 24 * 60 * 60 * 1000; 
        const USER_NAME_STORAGE_KEY = 'sanskrit_chat_user_name';
        
        // Firebase Config Fallback (User provided)
        const USER_PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDK_RPUQaQ86dzRhOOrrzRvRcG5pMyHR_E",
            authDomain: "sanskrit-chat.firebaseapp.com",
            projectId: "sanskrit-chat",
            storageBucket: "sanskrit-chat.firebasestorage.app",
            messagingSenderId: "328437332405",
            appId: "1:328437332405:web:ffd31f848b2351501fc1fc",
            measurementId: "G-X14R907GQB"
        };
        
        // --- APPLICATION STATE CONSTANTS ---
        const STATE = {
            NAME_INPUT: 'NAME_INPUT',
            ROOM_HUB: 'ROOM_HUB',
            CREATE_ROOM_FORM: 'CREATE_ROOM_FORM',
            JOIN_CODE_FORM: 'JOIN_CODE_FORM',
            CHAT: 'CHAT'
        };

        // --- GLOBAL VARIABLES ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sanskrit-chat-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId = null;
        let userName = '';
        let currentState = STATE.NAME_INPUT;
        let currentRoomCode = '';
        let currentRoomData = null; // Store room metadata for host check
        let messages = [];
        let publicRooms = [];
        let unsubscribePublicRooms = null; 
        let unsubscribeChat = null; 

        // DOM elements
        const mainViewContainer = document.getElementById('main-view-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const alertMessageBox = document.getElementById('alert-message-box');
        const alertText = document.getElementById('alert-text');
        const alertIcon = document.getElementById('alert-icon');


        // --- UTILITY FUNCTIONS ---

        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        function alertMessage(message, type = 'error') {
            const classMap = {
                'error': { bg: 'bg-red-100', border: 'border-red-500', text: 'text-red-700', icon: 'alert-triangle' },
                'info': { bg: 'bg-blue-100', border: 'border-blue-500', text: 'text-blue-700', icon: 'list' },
            };
            
            const config = classMap[type] || classMap['error'];
            
            alertMessageBox.className = `mb-4 p-3 border-l-4 ${config.bg} ${config.border} ${config.text} rounded-r-lg`;
            alertText.textContent = message;
            alertIcon.innerHTML = `<i data-lucide="${config.icon}" class="w-5 h-5 mr-2"></i>`;
            alertMessageBox.classList.remove('hidden');
            
            // Re-render icons for the alert box
            createIcons({ icons: lucideIcons, attrs: { color: config.text.replace('text-', '') }});

            setTimeout(() => {
                alertMessageBox.classList.add('hidden');
            }, 5000);
        }
        
        function showError(message) {
            alertMessage(message, 'error');
        }

        function switchState(newState) {
            console.log(`Switching state: ${currentState} -> ${newState}`);
            currentState = newState;
            renderState();
        }
        
        // --- FIREBASE INITIALIZATION AND AUTH ---

        async function initializeFirebase() {
            showLoading();
            
            // Load user name from local storage if available
            const storedName = localStorage.getItem(USER_NAME_STORAGE_KEY);
            if (storedName) {
                userName = storedName;
            }

            let firebaseConfig = USER_PROVIDED_FIREBASE_CONFIG;
            if (typeof __firebase_config !== 'undefined' && __firebase_config.trim() !== '') {
                try {
                    const envConfig = JSON.parse(__firebase_config);
                    if (envConfig.projectId) {
                        firebaseConfig = envConfig;
                    }
                } catch (e) {
                    console.warn("Could not parse __firebase_config, using hardcoded fallback.");
                }
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(auth, initialAuthToken);
                                } else {
                                    await signInAnonymously(auth);
                                }
                                userId = auth.currentUser.uid;
                            } catch (e) {
                                console.error("Anonymous/Custom sign-in failed:", e);
                                showError("Authentication failed. Cannot connect to chat.");
                                return;
                            }
                        }
                        console.log("Authentication successful. User ID:", userId);
                        resolve();
                    });
                });
                
                // Determine initial state based on persistent name
                if (userName) {
                    switchState(STATE.ROOM_HUB);
                } else {
                    switchState(STATE.NAME_INPUT);
                }
                
            } catch (error) {
                console.error("Fatal Error initializing Firebase:", error);
                showError("Fatal Error: Could not initialize app or connect to database.");
            } finally {
                hideLoading();
            }
        }
        
        // --- INACTIVITY CHECK & CLEANUP ---

        async function deleteExpiredRoom(roomCode) {
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode);
            try {
                await deleteDoc(roomRef);
                console.log(`Room ${roomCode} deleted due to inactivity.`);
            } catch (e) {
                // Ignore permission denied if the room was already deleted by another client
                console.warn(`Failed to delete expired room ${roomCode}:`, e.message);
            }
        }


        // --- REAL-TIME LISTENERS & ROOM LOGIC ---

        function setupPublicRoomListener() {
            if (unsubscribePublicRooms) {
                unsubscribePublicRooms();
                unsubscribePublicRooms = null;
            }
            if (!db) return;

            const roomsRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`);
            // Query only for public rooms. We must sort client-side.
            const publicRoomsQuery = query(roomsRef, where("isPublic", "==", true)); 

            unsubscribePublicRooms = onSnapshot(publicRoomsQuery, (snapshot) => {
                publicRooms = [];
                const now = Date.now();

                snapshot.forEach(doc => {
                    const room = { id: doc.id, ...doc.data() };
                    
                    // Client-Side Inactivity Check: Check if room is older than 24 hours (INACTIVITY_LIMIT_MS)
                    const createdAtTime = room.createdAt?.toDate().getTime() || 0;
                    const isExpired = now - createdAtTime > INACTIVITY_LIMIT_MS;

                    if (isExpired) {
                        // Trigger deletion if the room is too old, but don't add it to the list
                        deleteExpiredRoom(room.id); 
                    } else {
                        publicRooms.push(room);
                    }
                });
                
                // Client-side sort by creation time (newest first)
                publicRooms.sort((a, b) => {
                    const timeA = a.createdAt?.toDate().getTime() || 0;
                    const timeB = b.createdAt?.toDate().getTime() || 0;
                    return timeB - timeA;
                });

                if (currentState === STATE.ROOM_HUB) {
                    renderRoomHub();
                }
            }, (error) => {
                console.error("Error listening to public rooms:", error);
                alertMessage("Failed to load public rooms list.", 'info');
            });
        }
        
        function listenToChat(roomCode) {
            if (unsubscribeChat) {
                unsubscribeChat();
                unsubscribeChat = null;
            }
            if (!db || !roomCode) return;

            const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode, 'messages');
            const messagesQuery = query(messagesRef, orderBy('timestamp', 'asc'));

            unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
                messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                if (currentState === STATE.CHAT) {
                    renderChatMessages();
                }
            }, (error) => {
                console.error("Error listening to messages:", error);
                showError("Real-time connection lost. Check your network.");
                if (error.code === 'not-found' || error.code === 'permission-denied') {
                    alertMessage("The room you were in was closed by the host or no longer exists.", 'info');
                    switchState(STATE.ROOM_HUB);
                }
            });
        }
        
        function cleanupListeners() {
            if (unsubscribePublicRooms) {
                unsubscribePublicRooms();
            }
            if (unsubscribeChat) {
                unsubscribeChat();
            }
            unsubscribePublicRooms = null;
            unsubscribeChat = null;
            currentRoomData = null; // Clear room metadata
        }


        // --- SYSTEM MESSAGE SENDER ---
        async function sendSystemMessage(roomCode, type) {
            try {
                if (!db || !userName) throw new Error("Database or user name not ready.");
                const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCode, 'messages');

                await addDoc(messagesRef, {
                    type: 'system',
                    text: `${userName} has ${type.toLowerCase()} the chat.`,
                    userName: userName,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Failed to send system message:", e);
            }
        }

        // --- ROOM ACTIONS ---

        async function createRoom(roomName, isPublic) {
            showLoading();
            const newCode = generateRoomCode();
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, newCode);
            try {
                const roomSnap = await getDoc(roomRef);
                if (roomSnap.exists()) {
                    hideLoading();
                    return createRoom(roomName, isPublic);
                }

                const newRoomData = { 
                    createdAt: serverTimestamp(), 
                    hostId: userId,
                    hostName: userName,
                    roomName: roomName,
                    isPublic: isPublic
                };

                await setDoc(roomRef, newRoomData);
                
                currentRoomCode = newCode;
                currentRoomData = newRoomData; // Store new room data
                switchState(STATE.CHAT);
                listenToChat(newCode);
                sendSystemMessage(newCode, 'JOINED');

            } catch (e) {
                console.error("Error creating room:", e);
                showError("Failed to create room. Database error.");
            } finally {
                hideLoading();
            }
        }

        async function joinRoom(code) {
            code = code.toUpperCase().trim();
            if (!code || code.length !== 6) {
                showError("Invalid room code. It must be 6 characters.");
                return;
            }

            showLoading();
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, code);

            try {
                const roomSnap = await getDoc(roomRef);
                if (!roomSnap.exists()) {
                    showError(`Room '${code}' not found. Check the code.`);
                    return;
                }
                
                // Check for expiration immediately upon attempting to join
                const roomData = roomSnap.data();
                const createdAtTime = roomData.createdAt?.toDate().getTime() || 0;
                const isExpired = Date.now() - createdAtTime > INACTIVITY_LIMIT_MS;

                if (isExpired) {
                    await deleteExpiredRoom(code);
                    showError(`Room '${code}' was too old and has been deleted.`);
                    return;
                }

                currentRoomCode = code;
                currentRoomData = roomData; // Store joined room data
                switchState(STATE.CHAT);
                listenToChat(code);
                sendSystemMessage(code, 'JOINED');

            } catch (e) {
                console.error("Error joining room:", e);
                showError("Failed to join room. Database error.");
            } finally {
                hideLoading();
            }
        }
        
        async function deleteRoom() {
            if (currentRoomData.hostId !== userId) {
                showError("Permission denied. Only the room host can delete this room.");
                return;
            }

            showLoading();
            const roomCodeToDelete = currentRoomCode;
            const roomRef = doc(db, `artifacts/${appId}/public/data/sanskrit_rooms`, roomCodeToDelete);

            try {
                await deleteDoc(roomRef);
                
                currentRoomCode = '';
                currentRoomData = null;
                messages = [];
                switchState(STATE.ROOM_HUB);
                alertMessage(`Room ${roomCodeToDelete} has been successfully deleted.`, 'info');

            } catch (e) {
                console.error("Error deleting room:", e);
                showError("Failed to delete room. Check Firebase Security Rules.");
            } finally {
                hideLoading();
            }
        }
        
        function generateRoomCode() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return code;
        }
        
        // --- TRANSLATION LOGIC (Calls secure endpoint) ---
        
        async function callGroqApi(prompt) {
            const maxRetries = 3;
            let lastError = null;
            
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(TRANSLATION_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`Endpoint error! Status: ${response.status}. Message: ${errorData.error}`);
                    }

                    const result = await response.json();
                    const translatedText = result.sanskritText;
                    
                    if (!translatedText) {
                        throw new Error("API response was empty or malformed.");
                    }
                    return translatedText;

                } catch (e) {
                    lastError = e;
                    console.warn(`Attempt ${attempt + 1} failed:`, e.message);
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
            throw new Error(`Translation failed after ${maxRetries} attempts. ${lastError.message}`);
        }

        async function translateAndSendMessage(originalText) {
            if (!originalText.trim()) return;

            showLoading();
            let sanskritText = "Translation failed.";

            try {
                sanskritText = await callGroqApi(originalText);
                
            } catch (e) {
                console.error("Translation error:", e);
                showError(`Sanskrit translation failed: ${e.message}`);
                sanskritText = `[Translation Error] ${originalText}`; 
            }

            try {
                if (!db || !currentRoomCode) throw new Error("Chat not initialized.");
                const messagesRef = collection(db, `artifacts/${appId}/public/data/sanskrit_rooms`, currentRoomCode, 'messages');

                await addDoc(messagesRef, {
                    originalText: originalText,
                    sanskritText: sanskritText,
                    userId: userId,
                    userName: userName,
                    type: 'user',
                    timestamp: serverTimestamp()
                });

                document.getElementById('message-input').value = '';
                
            } catch (e) {
                console.error("Failed to send message:", e);
                showError("Could not send message to the room.");
            } finally {
                hideLoading();
            }
        }

        // --- UI RENDERERS ---

        function renderState() {
            mainViewContainer.innerHTML = '';
            
            if (currentState !== STATE.ROOM_HUB) {
                cleanupListeners();
            }

            switch (currentState) {
                case STATE.NAME_INPUT:
                    renderNameInput();
                    break;
                case STATE.ROOM_HUB:
                    renderRoomHub();
                    setupPublicRoomListener();
                    break;
                case STATE.CREATE_ROOM_FORM:
                    renderCreateRoomForm();
                    break;
                case STATE.JOIN_CODE_FORM:
                    renderJoinCodeForm();
                    break;
                case STATE.CHAT:
                    renderChat();
                    break;
                default:
                    renderNameInput();
            }
            createIcons({ icons: lucideIcons });
        }

        function renderNameInput() {
            mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Welcome to Sanskrit Chat!</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">First, enter your name to begin.</p>
                <input id="user-name-input" type="text" placeholder="Your Name" maxlength="20" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg mb-4">
                <button id="set-name-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    Continue
                </button>
            `;
            document.getElementById('set-name-btn').addEventListener('click', () => {
                const name = document.getElementById('user-name-input').value.trim();
                if (name) {
                    userName = name.substring(0, 20);
                    localStorage.setItem(USER_NAME_STORAGE_KEY, userName); // Save name
                    switchState(STATE.ROOM_HUB);
                } else {
                    showError("Please enter a name.");
                }
            });
        }
        
        function renderRoomHub() {
            const listItems = publicRooms.length > 0
                ? publicRooms.map(room => `
                    <div class="room-list-item p-3 border-b border-gray-200 flex justify-between items-center bg-white shadow-sm rounded-lg mb-2" data-room-code="${room.id}">
                        <div>
                            <p class="font-semibold text-gray-800">${room.roomName || 'Untitled Public Room'}</p>
                            <p class="text-xs text-gray-500">Host: ${room.hostName || 'Anonymous'}</p>
                        </div>
                        <button class="bg-blue-500 text-white text-xs font-semibold px-3 py-1 rounded-full hover:bg-blue-600">
                            Join
                        </button>
                    </div>
                `).join('')
                : '<p class="text-center text-gray-500 py-4">No public rooms available. Be the first to create one!</p>';

            mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Welcome to the Hub, ${userName}!</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">Browse public rooms or create your own.</p>
                
                <div class="bg-gray-50 p-3 rounded-lg max-h-60 overflow-y-auto mb-6 border border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 flex items-center text-gray-700 border-b pb-2">
                        <i data-lucide="list" class="w-5 h-5 mr-2 text-yellow-600"></i>
                        Active Public Rooms
                    </h3>
                    <div id="public-room-list">
                        ${listItems}
                    </div>
                </div>

                <div class="space-y-3">
                    <button id="create-room-nav-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                        Create a New Room
                    </button>
                    <button id="join-code-nav-btn" class="w-full flex items-center justify-center bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200">
                        <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                        Join Private by Code
                    </button>
                </div>
            `;
            
            document.getElementById('create-room-nav-btn').addEventListener('click', () => switchState(STATE.CREATE_ROOM_FORM));
            document.getElementById('join-code-nav-btn').addEventListener('click', () => switchState(STATE.JOIN_CODE_FORM));

            document.querySelectorAll('.room-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const roomCode = item.getAttribute('data-room-code');
                    joinRoom(roomCode);
                });
            });
        }

        function renderCreateRoomForm() {
            mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-6 text-center">Create Your Room</h2>

                <label for="room-name-input" class="block text-sm font-medium text-gray-700 mb-1">Room Name</label>
                <input id="room-name-input" type="text" placeholder="e.g., Sanskrit Practice Group" maxlength="30" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-lg mb-4">
                
                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg mb-6 border border-gray-200">
                    <label for="is-public-toggle" class="text-sm font-medium text-gray-700">Make this room public (Listed in Hub)</label>
                    <input type="checkbox" id="is-public-toggle" class="form-checkbox h-5 w-5 text-yellow-500 rounded border-gray-300 focus:ring-yellow-500" checked>
                </div>

                <button id="create-room-action-btn" class="w-full flex items-center justify-center bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                    Start Chat & Get Code
                </button>
                <button id="back-to-hub-btn" class="w-full mt-3 text-sm text-gray-500 hover:text-gray-700 p-2">
                    Back to Room Hub
                </button>
            `;
            document.getElementById('create-room-action-btn').addEventListener('click', () => {
                const roomName = document.getElementById('room-name-input').value.trim() || 'Untitled Room';
                const isPublic = document.getElementById('is-public-toggle').checked;
                createRoom(roomName, isPublic);
            });
            document.getElementById('back-to-hub-btn').addEventListener('click', () => switchState(STATE.ROOM_HUB));
        }

        function renderJoinCodeForm() {
             mainViewContainer.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-center">Join a Private Room</h2>
                <p class="text-sm text-gray-600 mb-6 text-center">Enter the 6-character code shared by the host.</p>
                <input id="room-code-input" type="text" placeholder="e.g., ABC123" maxlength="6" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-orange-500 focus:border-orange-500 text-lg uppercase mb-4 text-center tracking-widest font-mono">
                <button id="join-room-action-btn" class="w-full flex items-center justify-center bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-200 transform hover:scale-[1.02]">
                    <i data-lucide="log-in" class="w-5 h-5 mr-2"></i>
                    Connect to Chat
                </button>
                <button id="back-to-hub-btn" class="w-full mt-3 text-sm text-gray-500 hover:text-gray-700 p-2">
                    Back to Room Hub
                </button>
            `;
            document.getElementById('join-room-action-btn').addEventListener('click', () => {
                const code = document.getElementById('room-code-input').value;
                joinRoom(code);
            });
            document.getElementById('back-to-hub-btn').addEventListener('click', () => switchState(STATE.ROOM_HUB));
        }

        function renderChat() {
            // Check if current user is the host
            const isHost = currentRoomData && currentRoomData.hostId === userId;
            const deleteButtonHtml = isHost ? `
                <div id="delete-actions" class="mt-4 flex flex-col items-center">
                    <button id="show-delete-confirm-btn" class="text-sm text-red-500 hover:text-red-700 font-semibold p-1 transition duration-150 flex items-center">
                        <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i>
                        Delete Room
                    </button>
                    <div id="delete-confirm-box" class="hidden mt-2 p-3 bg-red-100 border border-red-400 rounded-lg shadow-md text-sm w-full">
                        <p class="text-red-700 font-medium mb-2">Are you sure? This action is permanent.</p>
                        <div class="flex justify-around">
                            <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md transition duration-150">
                                Yes, Delete
                            </button>
                            <button id="cancel-delete-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded-md transition duration-150">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';

            mainViewContainer.innerHTML = `
                <div class="flex items-center justify-between mb-4 pb-2 border-b-2 border-yellow-500">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="message-square" class="w-6 h-6 mr-2 text-orange-500"></i>
                        ${currentRoomData?.roomName || 'Chat Room'}
                    </h2>
                    <button id="leave-room-btn" class="text-sm text-red-500 hover:text-red-700 font-semibold p-1 transition duration-150">
                        Leave
                    </button>
                </div>

                <div class="mb-4 p-3 bg-blue-100 border-l-4 border-blue-500 text-blue-800 text-sm rounded-r-lg shadow-sm">
                    <p class="font-bold">Chatting as: ${userName} (Room Code: ${currentRoomCode})</p>
                </div>
                
                ${deleteButtonHtml}

                <div id="messages-list" class="chat-message-container space-y-4 p-2">
                    <div class="text-center text-gray-500 pt-8" id="empty-state">
                        Start your conversation in English or Hinglish!
                    </div>
                </div>

                <div class="mt-6">
                    <form id="message-form" class="flex">
                        <input type="text" id="message-input" placeholder="Type your English/Hinglish message..." class="flex-grow p-3 border border-gray-300 rounded-l-lg focus:ring-yellow-500 focus:border-yellow-500" required>
                        <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-r-lg transition duration-200 flex items-center">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </form>
                </div>
            `;
            
            document.getElementById('leave-room-btn').addEventListener('click', () => {
                sendSystemMessage(currentRoomCode, 'LEFT').then(() => {
                    switchState(STATE.ROOM_HUB);
                });
            });

            document.getElementById('message-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                translateAndSendMessage(input.value);
            });
            
            // Host deletion logic setup
            if (isHost) {
                const showDeleteBtn = document.getElementById('show-delete-confirm-btn');
                const deleteConfirmBox = document.getElementById('delete-confirm-box');
                const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
                const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

                showDeleteBtn.addEventListener('click', () => {
                    deleteConfirmBox.classList.remove('hidden');
                    showDeleteBtn.classList.add('hidden');
                });
                
                cancelDeleteBtn.addEventListener('click', () => {
                    deleteConfirmBox.classList.add('hidden');
                    showDeleteBtn.classList.remove('hidden');
                });

                confirmDeleteBtn.addEventListener('click', deleteRoom);
            }

            renderChatMessages(); 
        }

        function renderChatMessages() {
            const list = document.getElementById('messages-list');
            if (!list) return;

            if (messages.length === 0) {
                document.getElementById('empty-state')?.classList.remove('hidden');
                return;
            }
            document.getElementById('empty-state')?.classList.add('hidden');

            list.innerHTML = messages.map(msg => {
                // 1. System messages
                if (msg.type === 'system') {
                    return `
                        <div class="text-center my-3">
                            <span class="text-sm text-blue-600 font-medium bg-blue-100 py-1 px-3 rounded-full shadow-sm">
                                ${msg.text}
                            </span>
                        </div>
                    `;
                }

                // 2. User messages
                const isMine = msg.userId === userId;
                const displayName = isMine ? 'You' : msg.userName || 'Guest'; 
                const userColor = isMine ? 'text-orange-500' : 'text-blue-500';

                return `
                    <div class="flex ${isMine ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs md:max-w-md w-fit p-3 rounded-xl shadow-md ${isMine ? 'bg-orange-100 border-2 border-orange-300' : 'bg-white border-2 border-gray-200'}">
                            <p class="text-xs font-semibold mb-1 ${userColor}">${displayName}</p>

                            <p class="text-sm text-gray-700 italic border-b pb-1 mb-1">
                                ${msg.originalText}
                            </p>

                            <p class="text-xl font-extrabold text-black">
                                ${msg.sanskritText}
                            </p>
                            
                            <p class="text-[10px] text-gray-400 mt-1 text-right">
                                ${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString() : '...'}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');

            list.scrollTop = list.scrollHeight;
        }

        // --- START APPLICATION ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is the room host
    function isRoomHost(roomCode) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/artifacts/$(appId)/public/data/sanskrit_rooms/$(roomCode)).data.hostId == request.auth.uid;
    }
    
    // Allow access to artifacts collection structure
    match /artifacts/{appId} {
      
      // Public data section
      match /public/data/sanskrit_rooms/{roomCode} {
        
        // Room document rules
        // - Any authenticated user can read rooms (to browse public rooms)
        // - Any authenticated user can create rooms (they become the host)
        // - Only the room host can delete the room
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && 
                       request.resource.data.hostId == request.auth.uid;
        allow delete: if isAuthenticated() && 
                       resource.data.hostId == request.auth.uid;
        
        // Messages subcollection rules
        match /messages/{messageId} {
          
          // Anyone in an authenticated session can read messages
          allow read: if isAuthenticated();
          
          // Users can create their own messages
          allow create: if isAuthenticated() && 
                         request.resource.data.userId == request.auth.uid;
          
          // CRITICAL: Allow users to update messages for reactions and read receipts
          // This is the key fix for the reaction bug
          allow update: if isAuthenticated() && (
            // Allow updating reactions field (any authenticated user can react)
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions']) ||
            // Allow updating readBy field (for read receipts)
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']) ||
            // Allow updating both reactions and readBy together
            request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reactions', 'readBy'])
          );
          
          // Allow message sender to delete their own messages
          allow delete: if isAuthenticated() && 
                         resource.data.userId == request.auth.uid;
        }
      }
      
      // Allow other artifact paths for future expansion
      match /{document=**} {
        allow read, write: if false;
      }
    }
    
    // Block all other paths by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
